<!DOCTYPE html>
<html>

<head>
    <link rel="icon" href="https://static.iviva.com/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">

    <link rel="stylesheet" href="./node_modules/react-grid-layout/css/styles.css">
    <link rel="stylesheet" href="./node_modules/react-resizable/css/styles.css">

    <title>React Grid</title>
</head>

<body>
    <div id="root"></div>

    <!-- Dependencies -->
    <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>

    <script crossorigin src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/recharts/1.8.5/Recharts.min.js"></script>

    <!-- Main -->

    <script>

        let scripts = [
            "./resources/widgets/widget-set-01/main.js",
            "./resources/widgets/widget-set-03/main.js"
        ]

        let Widgets = [];

        // register widgets
        function registerWidgets(widgetConfig) {
            Widgets.push(widgetConfig);
        }


        // load scripts functions
        const loadWidgets = (widgets, callback) => {

            widgets.map((widget, i) => {
                loadScriptFile(widget);
            })

            if (typeof callback == "function") {
                callback();
            }
        }

        const loadScriptFile = (path, callback) => {
            var script = document.createElement('script');

            if (script.readyState) {  // only required for IE <9
                script.onreadystatechange = function () {
                    if (script.readyState === "loaded" || script.readyState === "complete") {
                        script.onreadystatechange = null;

                        if (typeof callback == "function") {
                            callback();
                        }
                    }
                };
            } else {  //Others
                script.onload = function () {
                    if (typeof callback == "function") {
                        callback();
                    }
                };
            }

            script.setAttribute('src', path);
            document.body.appendChild(script);
        }


        // get widgets from localstorage
        const loadFromLocalStorage = () => {
            let savedWidgets = JSON.parse(localStorage.getItem("saved_widgets"));
            if (savedWidgets == null) savedWidgets = [];

            let newWidgets = [];
            let returnWidgets = [];

            let __widgets = Widgets;

            __widgets.map(widget => {

                let savedWidget = savedWidgets.find(sw => sw.name == widget.name);

                if (typeof savedWidget == "undefined") {
                    newWidgets.push(widget);
                }
                else {
                    // get layout
                    widget.layout = savedWidget.layout;
                    widget.key = parseInt(savedWidget.key);

                    returnWidgets.push(widget);
                }
            });

           
            // generate layout for new widgets
            newWidgets.map((newWidget, i) => {
                let layout = { x: 0, y: 0, w: 6, h: 8, isDraggable: true, isResizable: true };

                let lastKey = i - 1;
                let last = returnWidgets[returnWidgets.length - 1];
                
                if (typeof last !== "undefined") {
                    lastKey = last.key;
                    let ll = last.layout;

                    layout.y = ll.y + ll.h + 1;
                    if ((ll.x + ll.w) < 12 && (ll.x + ll.w + 6) <= 12) {
                        layout.x = ll.x + ll.w + 1;
                        layout.y = ll.y
                    }
                }

                newWidget.layout = layout;
                newWidget.key = (parseInt(lastKey) + 1);

                returnWidgets.push(newWidget);
            })

            return returnWidgets;
        }


        // load widget scripts
        loadWidgets(scripts, loadScriptFile.bind(this, "./dist/main.js", () => {
            window.Widgets = loadFromLocalStorage();
            
            renderDashboard("root");
        }))

    </script>


</body>

</html>