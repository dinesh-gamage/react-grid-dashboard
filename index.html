<!DOCTYPE html>
<html>

<head>
    <link rel="icon" href="https://static.iviva.com/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">

    <link rel="stylesheet" href="./node_modules/react-grid-layout/css/styles.css">
    <link rel="stylesheet" href="./node_modules/react-resizable/css/styles.css">

    <title>React Grid</title>
</head>

<body>
    <div id="root"></div>

    <!-- Dependencies -->
    <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>

    <script crossorigin src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/recharts/1.8.5/Recharts.min.js"></script>

    <!-- Main -->

    <script>

        let scripts = [
            "./resources/widgets/widget-set-01/main.js",
            // "./resources/widgets/widget-set-03/main.js",
            "./resources/widgets/widget-set-04/main.js",
        ]

        let Widgets = [];

        // register widgets
        function registerWidget(widgetConfig) {
            Widgets.push(widgetConfig);
        }


        // load scripts functions
        const loadWidgets = (widgets, callback) => {

            widgets.map((widget, i) => {
                loadScriptFile(widget);
            })

            if (typeof callback == "function") {
                callback();
            }
        }

        const loadScriptFile = (path, callback) => {
            var script = document.createElement('script');

            if (script.readyState) {  // only required for IE <9
                script.onreadystatechange = function () {
                    if (script.readyState === "loaded" || script.readyState === "complete") {
                        script.onreadystatechange = null;

                        if (typeof callback == "function") {
                            callback();
                        }
                    }
                };
            } else {  //Others
                script.onload = function () {
                    if (typeof callback == "function") {
                        callback();
                    }
                };
            }

            script.setAttribute('src', path);
            document.body.appendChild(script);
        }

        // get layout for new widgets using configurations
        const getLayoutUsingConfigs = (widget) => {
            let layout = { x: 0, y: 0, w: 6, h: 8, isDraggable: true, isResizable: true };

            // check for configurations 
            if (widget.hasOwnProperty("configs")) {
                // console.log("widget has configs");
                let configs = widget["configs"];
                let sampleConfigKeys = ["w", "h", "isDraggable", "isResizable", "maxH", "maxW", "minH", "minW"];

                // remove additional configurations
                Object.keys(configs).map(key => {
                    if (sampleConfigKeys.indexOf(key) == -1) {
                        delete configs[key];
                    }
                })

                // merege config with layout
                // layout options will be replaced with configs
                let merged = { ...layout, ...configs };
                // console.log(merged);
                layout = merged;
            }

            return layout;
        }

        // get widgets from localstorage
        const loadFromLocalStorage = () => {
            let savedWidgets = JSON.parse(localStorage.getItem("saved_widgets"));
            if (savedWidgets == null) savedWidgets = [];

            let newWidgets = [];
            let returnWidgets = [];
            let lastLayout = null;

            let __widgets = Widgets;

            __widgets.map(widget => {

                let savedWidget = savedWidgets.find(sw => sw.name == widget.name);
                console.log(savedWidget);
                if (typeof savedWidget == "undefined") {
                    newWidgets.push(widget);
                }
                else {
                    // get layout
                    let savedLayout = savedWidget.layout
                    widget.layout = savedLayout;
                    widget.key = returnWidgets.length;// reset key  // parseInt(savedWidget.key);

                    returnWidgets.push(widget);

                    if(lastLayout === null) {
                        lastLayout = savedLayout;
                    }
                    else {
                        if(lastLayout.x < savedLayout.x || lastLayout.y < savedLayout.y) {
                            lastLayout = savedLayout;
                        }
                    }
                }
            });


            // generate layout for new widgets
            newWidgets.map((newWidget, i) => {
                let layout = getLayoutUsingConfigs(newWidget);

                if ((lastLayout === null && i === 0 && returnWidgets.length > 0) || (i > 0) ) {
                    let last = returnWidgets[returnWidgets.length -1];
                    lastLayout = last.layout;
                }


                if(lastLayout !== null){
                    layout.y = lastLayout.y + lastLayout.h + 1;
                    if ((lastLayout.x + lastLayout.w) < 12 && (lastLayout.x + lastLayout.w + 6) <= 12) {
                        layout.x = lastLayout.x + lastLayout.w + 1;
                        layout.y = lastLayout.y
                    }
                }

                layout.i = returnWidgets.length.toString();
                newWidget.layout = layout;
                newWidget.key = returnWidgets.length;

                returnWidgets.push(newWidget);
            })

            return returnWidgets;
        }


        // load widget scripts
        loadWidgets(scripts, loadScriptFile.bind(this, "./dist/main.js", () => {
            let _widgets = loadFromLocalStorage();
            window.Widgets = _widgets;

            renderDashboard("root");
        }))

    </script>


</body>

</html>